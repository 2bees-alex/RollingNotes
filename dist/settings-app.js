var templates=require("./defaultTemplates"),siteColorStyles;!function(){var t=angular.module("settingsApp",["ui.sortable"]);t.controller("settingsController",["$window","$scope","$http","$timeout",function(t,n,e,i){this.settings=t.settings;var o=function(t){return t.substring(t.indexOf(".")+1)},s=function(){var t=window.location.search.substring(window.location.search.indexOf("instance")+9,window.location.search.indexOf("&"));return t};n.updateComponent=function(t){this.settings=t,this.settings.instance=s(),e.post("/updateComponent",this.settings).success(function(){console.log("posting")}).error(function(t,n){console.log("OH NO! WE FAILED TO POST!!!!!"),console.log("data: "+t+"; status: "+n)}),Wix.Settings.triggerSettingsUpdatedEvent(settings,o(settings._id))};var r=function(t){var n=JSON.parse(JSON.stringify(templates[t].design));return"defaultNote"===t&&(n.text.color=siteColorStyles.color,n.background.color=siteColorStyles["background-color"],n.border.color=siteColorStyles["border-color"],n.hover.color=siteColorStyles.hover),n},a=function(t){Wix.UI.set("color",{cssColor:t.text.color}),Wix.UI.set("bcolorWOpacity",{rgba:t.background.color,opacity:t.background.opacity}),Wix.UI.set("bOpacitySpinner",100*t.background.opacity),Wix.UI.set("hcolorWOpacity",{rgba:t.hover.color,opacity:t.hover.opacity}),Wix.UI.set("hOpacitySlider",100*t.hover.opacity),Wix.UI.set("borderColor",{cssColor:t.border.color}),Wix.UI.set("borderWidth",t.border.width),Wix.UI.set("radius",t.border.radius),Wix.UI.set("hoverCheckbox",t.hover.selected)};this.resetTemplate=function(){var t=r(settings.design.template);a(t),settings.design=t,n.updateComponent(settings)};var c=function(t){var n=r(settings.design.template),e=r(t.value),i=JSON.parse(JSON.stringify(settings.design));DeepDiff.observableDiff(n,i,function(t){DeepDiff.applyChange(e,e,t)}),a(e),settings.design=e};Wix.UI.onChange("template",function(t){c(t),n.updateComponent(settings)}),Wix.UI.onChange("color",function(t){settings.design.text.color=t.cssColor,n.updateComponent(settings)}),Wix.UI.onChange("textAlignGroup",function(t){settings.design.text.alignment=t.value,n.updateComponent(settings)});var l=function(t){return t.substring(5,t.length-1).replace(/ /g,"").split(",")};Wix.UI.onChange("bcolorWOpacity",function(t){settings.design.background.color=t.rgba,settings.design.background.opacity=t.opacity,Wix.UI.set("bOpacitySpinner",100*settings.design.background.opacity),n.updateComponent(settings)}),Wix.UI.onChange("bOpacitySpinner",function(t){var e=l(settings.design.background.color);settings.design.background.color="rgba("+e[0]+","+e[1]+","+e[2]+","+t/100+")",settings.design.background.opacity=t/100,Wix.UI.set("bcolorWOpacity",{rgba:settings.design.background.color,opacity:settings.design.background.opacity}),n.updateComponent(settings)}),Wix.UI.onChange("hoverCheckbox",function(t){settings.design.hover.selected=t,n.updateComponent(settings)}),Wix.UI.onChange("hcolorWOpacity",function(t){settings.design.hover.selected||Wix.UI.set("hoverCheckbox",!0),settings.design.hover.color=t.rgba,settings.design.hover.opacity=t.opacity,Wix.UI.set("hOpacitySlider",100*settings.design.hover.opacity),n.updateComponent(settings)}),Wix.UI.onChange("hOpacitySlider",function(t){settings.design.hover.selected||Wix.UI.set("hoverCheckbox",!0);var e=l(settings.design.hover.color);settings.design.hover.color="rgba("+e[0]+","+e[1]+","+e[2]+","+t/100+")",settings.design.hover.opacity=t/100,Wix.UI.set("hcolorWOpacity",{rgba:settings.design.hover.color,opacity:settings.design.hover.opacity}),n.updateComponent(settings)}),Wix.UI.onChange("borderColor",function(t){settings.design.border.color=t.cssColor,n.updateComponent(settings)}),Wix.UI.onChange("borderWidth",function(t){settings.design.border.width=t,n.updateComponent(settings)}),Wix.UI.onChange("radius",function(t){settings.design.border.radius=t,n.updateComponent(settings)}),n.visibleManageNotes=!1,this.showManageNotes=function(){n.visibleManageNotes=!0,$(".character-count-normal").removeClass("character-count-max"),$("textarea").removeClass("note-text-max-count")},this.hideManageNotes=function(){n.visibleManageNotes=!1},this.blur=function(){$(".character-count-normal").removeClass("character-count-max"),$("textarea").removeClass("note-text-max-count"),n.updateComponent(settings)},n.settings=t.settings,n.$watchCollection("settings.notes",function(){n.updateComponent(settings)}),this.addNote=function(){settings.notes.push({visibility:!0,msg:"",key:g(),link:{type:"",url:"",display:"",targetVal:"0"}}),p()};var g=function(){function t(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}var n;return n=t()+t()+"-"+t()+"-"+t()+"-"+t()+"-"+t()+t()+t()},p=function(){i(function(){var t=$("textarea"),n=$(t[t.length-1]);n.focus()},0)};this.editNoteButton=function(t,n){this.settings.notes[n].visibility&&this.focusText(t)},this.focusText=function(t){i(function(){$("textarea:focus")||$("textarea:focus").blur(),$(t.target).closest(".note-container").find("textarea").focus()},0,!1)},this.deleteNote=function(t,n){t.splice(n,1)},n.hiddenNote=!1,n.showIcons=!1;var u=this;Wix.UI.onChange("transition",function(t){settings.transition.effect=t.value,u.playPreview()}),Wix.UI.onChange("duration",function(t){settings.transition.duration=Math.round(t),n.updateComponent(settings)}),this.playPreview=function(){settings.transition.preview=!0,n.updateComponent(settings),settings.transition.preview=!1},n.popupVisible=!1,n.upperTextVisible=!1,n.buttonsVisible=!1,n.optionsVisible=!1,n.linkOption=0,this.showLinkPopup=function(t){this.noteForLink=t,n.popupVisible=!0,n.buttonsVisible=!0,n.linkOption=0,h()},this.showLink=function(t){n.buttonsVisible=!1,n.optionsVisible=!0,n.linkOption=t},this.closeLinkPopup=function(){n.popupVisible=!1,n.upperTextVisible=!1,n.buttonsVisible=!1,n.optionsVisible=!1,n.linkOption=0},this.setLink=function(){n.options={1:"webLink",2:"pageLink",3:"emailLink",4:"docLink"};var t=n.options[n.linkOption],e=this.noteForLink[t];switch(d(this.noteForLink),this.noteForLink[t]=e,this.noteForLink.link.url=e,n.linkOption){case 1:this.noteForLink.link.display=e,console.log("targetVal: "+this.noteForLink.link.targetVal),this.noteForLink.link.target="1"===this.noteForLink.link.targetVal?"_top":"_blank",console.log("Target: "+this.noteForLink.link.target);break;case 2:var i=this,o=n,s=settings.pages.indexOf(this.noteForLink.pageLink);this.noteForLink.link.display=e,this.noteForLink.link.target="_top",Wix.Worker.getSiteInfo(function(t){i.noteForLink.link.url=t.baseUrl+"#!/"+i.settings.pageIds[s],o.updateComponent(i.settings)});break;case 3:this.noteForLink.link.url=k(this.noteForLink.emailLink,{subject:this.noteForLink.link.subject}),this.noteForLink.link.display="mail to: "+this.noteForLink.emailLink,this.noteForLink.link.target="";break;case 4:this.noteForLink.link.target="_blank",this.noteForLink.link.doc=!0}this.noteForLink.link.display=this.noteForLink.link.display.substring(0,30),n.updateComponent(settings),this.closeLinkPopup()},this.backToOptions=function(){n.optionsVisible=!1,n.buttonsVisible=!0,n.linkOption=0};var d=function(t){t.webLink="",t.pageLink="",t.emailLink="",t.docLink="",t.link.doc=!1,t.link.subject="",t.link.url=""};this.removeLink=function(t){d(t),t.link.display="",n.updateComponent(settings),this.closeLinkPopup()};var h=function(){Wix.getSitePages(function(t){settings.pages=_.pluck(t,"title"),settings.pageIds=_.pluck(t,"id")})},k=function(t,n){var e="mailto:";e+=window.encodeURIComponent(t);var i=[];return angular.forEach(n,function(t,n){i.push(n.toLowerCase()+"="+window.encodeURIComponent(t))}),i.length>0&&(e+="?"+i.join("&")),e};this.docLink=function(){var t=this,e=n;Wix.Settings.openMediaDialog(Wix.Settings.MediaType.DOCUMENT,!1,function(i){Wix.Utils.Media.getDocumentUrl(i.relativeUri);t.noteForLink.docLink=i.relativeUri,n.$apply(function(){t.noteForLink.link.display=i.fileName,t.noteForLink.link.display=t.noteForLink.link.display.substring(0,30),e.updateComponent(settings)})})},$(document).ready(function(){Wix.UI.initialize({numOfImages:100,isIconShown:!0,imageVisibility:"show",imagesToSync:0,imageLink:!1});var t=document.registerElement("site-template-colors");document.body.appendChild(new t);var n=["color","background-color","border-color"];siteColorStyles=$("site-template-colors").css(n),siteColorStyles.hover=$("site-template-colors").css("outline-color"),"color-1"===settings.design.text.color&&(settings.design=r("defaultNote"))})}]),t.directive("httpPrefix",function(){return{restrict:"A",require:"ngModel",link:function(t,n,e,i){function o(t){return t&&!/^(https):\/\//i.test(t)&&-1==="https://".indexOf(t)?(i.$setViewValue("https://"+t),i.$render(),"https://"+t):t}i.$formatters.push(o),i.$parsers.push(o)}}})}();